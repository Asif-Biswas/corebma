{% load static %}
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0" />

    <title>Core</title>

    <meta name="description" content="" />

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="{% static 'assets/img/favicon/favicon.ico' %}" />

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Public+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300;1,400;1,500;1,600;1,700&ampdisplay=swap"
      rel="stylesheet" />

    <link rel="stylesheet" href="{% static 'assets/vendor/fonts/fontawesome.css' %}" />
    <link rel="stylesheet" href="{% static 'assets/vendor/fonts/tabler-icons.css' %}" />
    <link rel="stylesheet" href="{% static 'assets/vendor/fonts/flag-icons.css' %}" />

    <link rel="stylesheet" href="{% static 'assets/vendor/css/rtl/core.css' %}" class="template-customizer-core-css" />
    <link rel="stylesheet" href="{% static 'assets/vendor/css/rtl/theme-default-dark.css' %}" class="template-customizer-theme-css" />
    <link rel="stylesheet" href="{% static 'assets/css/demo.css' %}" />
    <link rel="stylesheet" href="{% static 'assets/vendor/css/rtl/core-dark.css' %}" class="template-customizer-core-css" />
    
    <link rel="stylesheet" href="{% static 'assets/vendor/libs/node-waves/node-waves.css' %}" />
    <link rel="stylesheet" href="{% static 'assets/vendor/libs/perfect-scrollbar/perfect-scrollbar.css' %}" />
    <link rel="stylesheet" href="{% static 'assets/vendor/libs/typeahead-js/typeahead.css' %}" />
    <link rel="stylesheet" href="{% static 'assets/vendor/libs/bootstrap-maxlength/bootstrap-maxlength.css' %}" />
    <link rel="stylesheet" href="{% static 'assets/vendor/css/pages/app-chat.css' %}" />
    <script src="{% static 'assets/vendor/js/helpers.js' %}"></script>
    <script src="{% static 'assets/vendor/js/template-customizer.js' %}"></script>
    <script src="{% static 'assets/js/config.js' %}"></script>
    <script src="https://unpkg.com/htmx.org@1.6.0"></script>
    <style>
      .hide-scrollbar::-webkit-scrollbar {
        display: none;
      }
      
      .my-sidebar-menu{
        max-height: 99vh;
        overflow-y: scroll;
      }
    </style>
  </head>

  <body>
  <!-- Layout wrapper -->
  <div class="layout-wrapper layout-content-navbar">
    <div class="layout-container">
      <!-- Menu -->

      
      <!-- / Menu -->

      <!-- Layout container -->
      <div class="layout-page" style="width: 100%; max-width: 1000px; margin: auto">
        
        <div class="container mt-4 d-flex justify-content-between">
            <a href="{% url 'home' %}" >
                <button class="btn btn-primary active"><i class="fas fa-external-link-alt me-2"></i> Visit Our Website</button>
            </a>
            <a href="{% url 'login' %}" >
                <button class="btn btn-primary active"><i class="fas fa-sign-in-alt me-2"></i> Login</button>
            </a>
        </div>

        <!-- Content wrapper -->
        <div class="content-wrapper" id="body-wrapper">

            <div class="container-xxl flex-grow-1 container-p-y">
                <div class="app-chat card overflow-hidden">
                  <div class="row g-0">
                    <!-- Sidebar Left -->
                    <div class="col app-chat-sidebar-left app-sidebar overflow-hidden" id="app-chat-sidebar-left">
                      <div
                        class="chat-sidebar-left-user sidebar-header d-flex flex-column justify-content-center align-items-center flex-wrap px-4 pt-5">
                        <div class="avatar avatar-xl avatar-online">
                          <img src="../../assets/img/avatars/1.png" alt="Avatar" class="rounded-circle" />
                        </div>
                        <h5 class="mt-2 mb-0">John Doe</h5>
                        <span>Admin</span>
                        <i
                          class="ti ti-x ti-sm cursor-pointer close-sidebar"
                          data-bs-toggle="sidebar"
                          data-overlay
                          data-target="#app-chat-sidebar-left"></i>
                      </div>
                      <div class="sidebar-body px-4 pb-4">
                        <div class="my-4">
                          <small class="text-muted text-uppercase">About</small>
                          <textarea
                            id="chat-sidebar-left-user-about"
                            class="form-control chat-sidebar-left-user-about mt-3"
                            rows="4"
                            maxlength="120">
                            Dessert chocolate cake lemon drops jujubes. Biscuit cupcake ice cream bear claw brownie brownie marshmallow.
                          </textarea>
                        </div>
                        <div class="my-4">
                          <small class="text-muted text-uppercase">Status</small>
                          <div class="d-grid gap-2 mt-3">
                            <div class="form-check form-check-success">
                              <input
                                name="chat-user-status"
                                class="form-check-input"
                                type="radio"
                                value="active"
                                id="user-active"
                                checked />
                              <label class="form-check-label" for="user-active">Active</label>
                            </div>
                            <div class="form-check form-check-danger">
                              <input
                                name="chat-user-status"
                                class="form-check-input"
                                type="radio"
                                value="busy"
                                id="user-busy" />
                              <label class="form-check-label" for="user-busy">Busy</label>
                            </div>
                            <div class="form-check form-check-warning">
                              <input
                                name="chat-user-status"
                                class="form-check-input"
                                type="radio"
                                value="away"
                                id="user-away" />
                              <label class="form-check-label" for="user-away">Away</label>
                            </div>
                            <div class="form-check form-check-secondary">
                              <input
                                name="chat-user-status"
                                class="form-check-input"
                                type="radio"
                                value="offline"
                                id="user-offline" />
                              <label class="form-check-label" for="user-offline">Offline</label>
                            </div>
                          </div>
                        </div>
                        <div class="my-4">
                          <small class="text-muted text-uppercase">Settings</small>
                          <ul class="list-unstyled d-grid gap-2 me-3 mt-3">
                            <li class="d-flex justify-content-between align-items-center">
                              <div>
                                <i class="ti ti-message me-1 ti-sm"></i>
                                <span class="align-middle">Two-step Verification</span>
                              </div>
                              <label class="switch switch-primary me-4 switch-sm">
                                <input type="checkbox" class="switch-input" checked="" />
                                <span class="switch-toggle-slider">
                                  <span class="switch-on"></span>
                                  <span class="switch-off"></span>
                                </span>
                              </label>
                            </li>
                            <li class="d-flex justify-content-between align-items-center">
                              <div>
                                <i class="ti ti-bell me-1 ti-sm"></i>
                                <span class="align-middle">Notification</span>
                              </div>
                              <label class="switch switch-primary me-4 switch-sm">
                                <input type="checkbox" class="switch-input" />
                                <span class="switch-toggle-slider">
                                  <span class="switch-on"></span>
                                  <span class="switch-off"></span>
                                </span>
                              </label>
                            </li>
                            <li>
                              <i class="ti ti-user-plus me-1 ti-sm"></i>
                              <span class="align-middle">Invite Friends</span>
                            </li>
                            <li>
                              <i class="ti ti-trash me-1 ti-sm"></i>
                              <span class="align-middle">Delete Account</span>
                            </li>
                          </ul>
                        </div>
                        <div class="d-flex mt-4">
                          <button
                            class="btn btn-primary"
                            data-bs-toggle="sidebar"
                            data-overlay
                            data-target="#app-chat-sidebar-left">
                            Logout
                          </button>
                        </div>
                      </div>
                    </div>
                    <!-- /Sidebar Left-->
              
                    <!-- Chat & Contacts -->
                    
                    <!-- /Chat contacts -->
                    
                    <div class="col app-chat-history bg-body" id="conversation-history">
                        <div class="chat-history-wrapper">
                            {% if history %}
                          <div class="chat-history-header border-bottom">
                            <div class="d-flex justify-content-between align-items-center">
                              <div class="d-flex overflow-hidden align-items-center">
                                <i
                                  class="ti ti-menu-2 ti-sm cursor-pointer d-lg-none d-block me-2"
                                  data-bs-toggle="sidebar"
                                  data-overlay
                                  data-target="#app-chat-contacts"></i>
                                <div class="flex-shrink-0 avatar">
                                  <img
                                    {% if history.user_one == myuser %}
                                        {% if history.user_two.userprofile.profile_pic %}
                                            src="{{history.user_two.userprofile.profile_pic.url}}"
                                        {% else %}
                                            src="{% static 'images/user.png' %}"
                                        {% endif %}
                                    {% else %}
                                        {% if history.user_one.userprofile.profile_pic %}
                                            src="{{history.user_one.userprofile.profile_pic.url}}"
                                        {% else %}
                                            src="{% static 'images/user.png' %}"
                                        {% endif %}
                                    {% endif %}
                                    alt="Avatar"
                                    class="rounded-circle"
                                    data-bs-toggle="sidebar"
                                    data-overlay
                                    data-target="#app-chat-sidebar-right" />
                                </div>
                                <div class="chat-contact-info flex-grow-1 ms-2">
                                  <h6 class="m-0">
                                    {% if history.user_one == myuser %}
                                        {{history.user_two.first_name}} {{history.user_two.last_name}}
                                    {% else %}
                                        {{history.user_one.first_name}} {{history.user_one.last_name}}
                                    {% endif %}
                                  </h6>
                                  <small class="user-status text-muted">
                                    {{history.get_last_message.date|timesince}}
                                  </small>
                                </div>
                              </div>
                            </div>
                          </div>
                          <div class="chat-history-body bg-body hide-scrollbar" style="overflow-y: scroll">
                            <ul class="list-unstyled chat-history" id="history-chat-list">
                                {% for message in history.messages.all %}
                                    {% if message.sender == myuser %}
                                    <li class="chat-message chat-message-right">
                                        <div class="d-flex overflow-hidden">
                                        <div class="chat-message-wrapper flex-grow-1">
                                            <div class="chat-message-text">
                                            <p class="mb-0 my-text-color">
                                                {{message.text}}
                                            </p>
                                            </div>
                                            <div class="text-end text-muted mt-1">
                                            <small>
                                                {{ message.date|date:"d M Y H:i" }}
                                            </small>
                                            </div>
                                        </div>
                                        <div class="user-avatar flex-shrink-0 ms-3">
                                            <div class="avatar avatar-sm">
                                            <img src="{% if message.sender.userprofile.profile_pic %} {{message.sender.userprofile.profile_pic.url}} {% else %} {% static 'images/user.png' %} {% endif %}" alt="Avatar" class="rounded-circle" />
                                            </div>
                                        </div>
                                        </div>
                                    </li>
                                    {% else %}
                                    <li class="chat-message">
                                      <div class="d-flex overflow-hidden">
                                        <div class="user-avatar flex-shrink-0 me-3">
                                          <div class="avatar avatar-sm">
                                            <img src="{% if message.sender.userprofile.profile_pic %} {{message.sender.userprofile.profile_pic.url}} {% else %} {% static 'images/user.png' %} {% endif %}" alt="Avatar" class="rounded-circle" />
                                          </div>
                                        </div>
                                        <div class="chat-message-wrapper flex-grow-1">
                                          <div class="chat-message-text" style="background-color:#2f3349;">
                                            <p class="mb-0">
                                                {{message.text}}
                                            </p>
                                          </div>
                                          <div class="text-muted mt-0">
                                            <small>
                                                {{ message.date|date:"d M Y H:i" }}
                                            </small>
                                          </div>
                                        </div>
                                      </div>
                                    </li>
                                    {% endif %}
                              {% endfor %}
                            </ul>
                          </div>
                          <!-- Chat message form -->
                          <div class="chat-history-footer shadow-sm" style="background-color: #2f3349;">
                            <form hx-post="{% url 'send_message' history.id %}" 
                                hx-target="#history-chat-list"
                                hx-swap="beforeend"
                                class="d-flex justify-content-between align-items-center">
                                <input
                                class="form-control message-input border-0 me-3 shadow-none"
                                name="text"
                                placeholder="Type your message here" />
                              <div class="message-actions d-flex align-items-center">
                                <button onclick="sendBtnClicked()" class="btn btn-primary active d-flex ">
                                  <i class="ti ti-send me-md-1 me-0"></i>
                                  <span class="align-middle d-md-inline-block d-none">Send</span>
                                </button>
                              </div>
                            </form>
                          </div> 
                          {% else %}
                            <div class="chat-history-body bg-body">
                                <div class="d-flex flex-column justify-content-center align-items-center h-100">
                                <div class="avatar avatar-xl mb-3">
                                    <img src="{% if myuser.userprofile.profile_pic %}{{myuser.userprofile.profile_pic.url}}{% else %}{% static 'images/user.png' %}{% endif %}" alt="Avatar" class="rounded-circle" />
                                </div>
                                <h5 class="mb-1">Select a chat to start messaging</h5>
                                <p class="text-muted">
                                    Select a chat from the left, or search for a contact to start a new chat.
                                </p>
                                </div>
                            </div>
                          {% endif %}
                        </div>
                      </div>
                      <!-- /Chat History -->
                    
                        <script>
                            $(document).ready(function(){
                                var objDiv = document.querySelector(".chat-history-body.bg-body.hide-scrollbar");
                                objDiv.scrollTop = objDiv.scrollHeight;
                            });
                    
                            function sendBtnClicked(){
                                setTimeout(function(){
                                    document.querySelector(".message-input").value = "";
                                    var objDiv = document.querySelector(".chat-history-body.bg-body.hide-scrollbar");
                                    objDiv.scrollTo({
                                        top: objDiv.scrollHeight,
                                        behavior: 'smooth'
                                    })
                                }, 500);
                            }
                        </script>
              
                    <!-- Sidebar Right -->
                    <div class="col app-chat-sidebar-right app-sidebar overflow-hidden" id="app-chat-sidebar-right">
                      <div
                        class="sidebar-header d-flex flex-column justify-content-center align-items-center flex-wrap px-4 pt-5">
                        <div class="avatar avatar-xl avatar-online">
                          <img src="../../assets/img/avatars/2.png" alt="Avatar" class="rounded-circle" />
                        </div>
                        <h6 class="mt-2 mb-0">Felecia Rower</h6>
                        <span>NextJS Developer</span>
                        <i
                          class="ti ti-x ti-sm cursor-pointer close-sidebar d-block"
                          data-bs-toggle="sidebar"
                          data-overlay
                          data-target="#app-chat-sidebar-right"></i>
                      </div>
                      <div class="sidebar-body px-4 pb-4">
                        <div class="my-4">
                          <small class="text-muted text-uppercase">About</small>
                          <p class="mb-0 mt-3">
                            A Next. js developer is a software developer who uses the Next. js framework alongside ReactJS
                            to build web applications.
                          </p>
                        </div>
                        <div class="my-4">
                          <small class="text-muted text-uppercase">Personal Information</small>
                          <ul class="list-unstyled d-grid gap-2 mt-3">
                            <li class="d-flex align-items-center">
                              <i class="ti ti-mail ti-sm"></i>
                              <span class="align-middle ms-2">josephGreen@email.com</span>
                            </li>
                            <li class="d-flex align-items-center">
                              <i class="ti ti-phone-call ti-sm"></i>
                              <span class="align-middle ms-2">+1(123) 456 - 7890</span>
                            </li>
                            <li class="d-flex align-items-center">
                              <i class="ti ti-clock ti-sm"></i>
                              <span class="align-middle ms-2">Mon - Fri 10AM - 8PM</span>
                            </li>
                          </ul>
                        </div>
                        <div class="mt-4">
                          <small class="text-muted text-uppercase">Options</small>
                          <ul class="list-unstyled d-grid gap-2 mt-3">
                            <li class="cursor-pointer d-flex align-items-center">
                              <i class="ti ti-badge ti-sm"></i>
                              <span class="align-middle ms-2">Add Tag</span>
                            </li>
                            <li class="cursor-pointer d-flex align-items-center">
                              <i class="ti ti-star ti-sm"></i>
                              <span class="align-middle ms-2">Important Contact</span>
                            </li>
                            <li class="cursor-pointer d-flex align-items-center">
                              <i class="ti ti-photo ti-sm"></i>
                              <span class="align-middle ms-2">Shared Media</span>
                            </li>
                            <li class="cursor-pointer d-flex align-items-center">
                              <i class="ti ti-trash ti-sm"></i>
                              <span class="align-middle ms-2">Delete Contact</span>
                            </li>
                            <li class="cursor-pointer d-flex align-items-center">
                              <i class="ti ti-ban ti-sm"></i>
                              <span class="align-middle ms-2">Block Contact</span>
                            </li>
                          </ul>
                        </div>
                      </div>
                    </div>
                    <!-- /Sidebar Right -->
              
                    <div class="app-overlay"></div>
                  </div>
                </div>
              </div>

            

            
          </div>
          <!-- Content wrapper -->
        </div>
        <!-- / Layout page -->
      </div>

      <!-- Overlay -->
      <div class="layout-overlay layout-menu-toggle"></div>

      <!-- Drag Target Area To SlideIn Menu On Small Screens -->
      <div class="drag-target"></div>
    </div>

    <script>
      document.body.addEventListener('htmx:configRequest', (event) => {
          event.detail.headers['X-CSRFToken'] = '{{ csrf_token }}'; //insert csrf token when performing AJAX request 
      })
      </script>

    <script src="{% static 'assets/vendor/libs/jquery/jquery.js' %}" type="text/javascript"></script>
    <script src="{% static 'assets/vendor/libs/popper/popper.js' %}" type="text/javascript"></script>
    <script src="{% static 'assets/vendor/js/bootstrap.js' %}" type="text/javascript"></script>
    <script src="{% static 'assets/vendor/libs/node-waves/node-waves.js' %}" type="text/javascript"></script>
    <script src="{% static 'assets/vendor/libs/perfect-scrollbar/perfect-scrollbar.js' %}" type="text/javascript"></script>
    <script src="{% static 'assets/vendor/libs/hammer/hammer.js' %}" type="text/javascript"></script>
    <script src="{% static 'assets/vendor/libs/i18n/i18n.js' %}" type="text/javascript"></script>
    <script src="{% static 'assets/vendor/libs/typeahead-js/typeahead.js' %}" type="text/javascript"></script>
    <script src="{% static 'assets/vendor/js/menu.js' %}" type="text/javascript"></script>


    <!-- endbuild -->

    <!-- Vendors JS -->
    {% comment %} <script src="../../assets/vendor/libs/bootstrap-maxlength/bootstrap-maxlength.js"></script> {% endcomment %}
    <script src="{% static 'assets/vendor/libs/bootstrap-maxlength/bootstrap-maxlength.js' %}" type="text/javascript"></script>

    <script src="{% static 'assets/js/main.js' %}" type="text/javascript"></script>
    <script src="{% static 'assets/js/app-chat.js' %}" type="text/javascript"></script>
  </body>
</html>